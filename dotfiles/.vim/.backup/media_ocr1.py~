#!/bin/python3
# import the necessary packages
import os
import string
import textract
import pytesseract
from PIL import Image as PilImage

CANNOT_PROCESS = 'CANNOT_PROCESS'
UNRECODNOSED = 'UNRECODNOSED'
NOT_SUPPLIED = 'NOT_SUPPLIED'
NOT_EXIST = 'NOT_EXIST'
NOT_SUPPORTED = 'NOT_SUPPORTED'

class MediaOcr():

    """Docstring for Test. """
    def __init__(self, *args, **kwargs):
        self.text = 'Unable_to_OCR_this_file'
        self.accepted_document_list = self.__compile_document_list()
        self.accepted_image_list = self.__compile_image_list()

    def __compile_document_list(self, *args, **kwargs):
        return ['.csv', '.doc', '.docx', '.eml', '.epub', '.gif', '.htm',
                '.html', '.jpeg', '.jpg', '.json', '.log', '.mp3', '.msg',
                '.odt', '.ogg', '.pdf', '.png', '.pptx', '.ps', '.psv',
                '.rtf', '.tff', '.tif', '.tiff', '.tsv', '.txt', '.wav',
                '.xls', '.xlsx']

    def __compile_image_list(self, *args, **kwargs):
        return ['.jfif', '.jpeg', '.jpg', '.png', '.tff', '.tif', '.tiff']


    def __set_success_return(self, text='', *args, **kwargs):
        return {'success': True, 'message': 'Success', 'text': text}

    def __set_error_return(self, error_code='',*args, **kwargs):
        message = 'Unspecified Error Code.'

        if error_code == CANNOT_PROCESS:
            message = 'Unable to OCR this file.'

        if error_code == UNRECODNOSED:
            message = 'File contains no recognisable text.'

        if error_code == NOT_SUPPLIED:
            message = 'No file has been supplied.'

        if error_code == NOT_EXIST:
            message = 'Supplied file does not exist.'

        if error_code == NOT_SUPPORTED:
            message = 'File format is not currently supported.'

        return {'success': False, 'message': message, 'text': '',}

    def __sanitise_the_text(self, *args, **kwargs):
        return_text = ' '.join(self.text.split())
        if not self.text or len(return_text) == 0:
            return self.__set_error_return(UNRECODNOSED)
        return self.__set_success_return(return_text)

    def __read_the_doc(self, *args, **kwargs):
        try:
            raw_text = textract.process(self.file_name, encoding='ascii')
            self.text = str(raw_text, 'utf-8')
            return self.__sanitise_the_text()

        except: # IntegrityError:
            return  self.__set_error_return(CANNOT_PROCESS)

    def __read_the_image(self, *args, **kwargs):
        try:
            raw_image = PilImage.open(self.file_name)
            self.text = pytesseract.image_to_string(raw_image)
            return self.__sanitise_the_text()

        except: # IntegrityError:
            return self.__set_error_return(CANNOT_PROCESS)

    def process_file(self, file_name='', *args, **kwargs):
        if not file_name:
            return self.__set_error_return(NOT_SUPPLIED)

        # self.base_name = os.path.basename(self.file_name)
        self.file_name = os.path.abspath(file_name)
        # self.directory_name = os.path.dirname(self.file_name)
        if not os.path.exists(self.file_name):
            return self.__set_error_return(NOT_EXIST)

        raw_file_name, extension = os.path.splitext(self.file_name)

        if extension in self.accepted_document_list:
            return self.__read_the_doc()

        elif extension in self.accepted_image_list:
            return self.__read_the_image()

        return self.__set_error_return(NOT_SUPPORTED)


if __name__ == "__main__":

    m = MediaOcr()

    result = m.process_file('pitfall.pdf')
    print(result)

    result = m.process_file('heavy.jpg')
    print(result)

    result = m.process_file('me.jpg')
    print(result)

    result = m.process_file('sometext.png')
    print(result)
