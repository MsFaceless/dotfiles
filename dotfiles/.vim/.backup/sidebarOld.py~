#!/bin/python
# -*- coding: utf-8 -*-

from tg import expose, request

from tg.i18n import ugettext as _
from tg.i18n import lazy_ugettext as l_

from rocket.lib.base import BaseController

class SidebarController(BaseController):

    @expose()
    def get_html(self, *args, **kwargs):
        home_segment = self.get_sidebar_home_segment()
        profile_segment = self.get_sidebar_profile_segment()
        operational_dropdown = self.get_sidebar_operational_dropdown()
        reports_dropdown = self.get_sidebar_reports_dropdown()
        setup_dropdown = self.get_sidebar_setup_dropdown()
        html = f"""
        <div class="sidebar-wrapper" id="sidebar-wrapper">
            {home_segment}
            {profile_segment}
            <ul class="nav">
                {operational_dropdown}
                {reports_dropdown}
                {setup_dropdown}
            </ul>
        </div>
        """
        javascript = """
        <script>
            $(document).ready(function(){
                var origin = window.location.origin;
                var url = window.location.href.replace(origin, '');
                $('.sidebar-wrapper a').each(function(){
                    var href = $(this).attr('href');
                    if(href === url && href != '/profile/index'){
                        $(this).closest('li').addClass('active');
                        $(this).closest('li').parent().closest('div').addClass('show');
                        $(this).closest('li').parent().closest('li').addClass('active');
                        $(this).closest('li').parent().closest('a').attr('aria-expanded', true);
                    };
                });
            });
        </script>
        """
        return html + javascript

    def get_sidebar_home_segment(self, *args, **kwargs):
        html = """
          <div class="logo">
            <a href="/" class="simple-text logo-mini">
              <i class="now-ui-icons objects_spaceship"></i>
            </a>
            <a href="/" class="simple-text logo-normal">
              Rocket
            </a>
          </div>
        """
        return html

    def get_sidebar_profile_segment(self, *args, **kwargs):
        profile = self.create_nav_li(**{'icon_text': 'MP', 'name': 'My Profile', 'link': '/profile/index'})
        logout = self.create_nav_li(**{'icon_text': 'L', 'name': 'Logout', 'link': '/logout'})
        usernow = request.identity.get('user')
        html = f"""
        <div class="user">
          <div class="photo">
            <img onerror='$(this).attr("src", "/images/nothing.png")' src="/images/{usernow.id}.png" />
          </div>
          <div class="info">
            <a data-toggle="collapse" href="#profileCollapse">
              <span> {usernow.name} <b class="caret"></b> </span>
            </a>
            <div class="clearfix"></div>
            <div class="collapse" id="profileCollapse">
              <ul class="nav">
                {profile}
                {logout}
              </ul>
            </div>
          </div>
        </div>
        """
        return html

    def get_sidebar_operational_dropdown(self, *args, **kwargs):

        members_all = self.create_nav_li(**{'icon_text': 'M', 'name': 'Members', 'link': '/members/index', 'role_list' : ['Administrator', 'Membership']})
        policy_new = self.create_nav_li(**{'icon_text': 'NP', 'name': 'New Policy', 'link': '/policy/new', 'role_list': ['Administrator', 'Catalog Maintenance']})

        beneficiary_new = self.create_nav_li(**{'icon_text': 'BF', 'name': 'Beneficiaries', 'link': '/policy/beneficiaries', 'role_list': ['Administrator', 'Catalog Maintenance']})
        policy_benefit_status = self.create_nav_li(**{'icon_text': 'PB', 'name': 'Policy Benefit Status', 'link': '/policy_benefit_status/status',
                                                      'role_list': ['Administrator', 'Catalog Maintenance']})
        policy_benefit_loader = self.create_nav_li(**{'icon_text': 'PL', 'name': 'Policy Benefit Loaders', 'link': '/policy_benefit_loader/loaders',
                                                      'role_list': ['Administrator', 'Catalog Maintenance']})
        policy_status = self.create_nav_li(
            **{'icon_text': 'PS', 'name': 'Policy Status', 'link': '/policy_status/status',
               'role_list': ['Administrator', 'Catalog Maintenance']})
        policy_benefit_asset_vehicle = self.create_nav_li(
            **{'icon_text': 'PBAV', 'name': 'Policy Benefit Asset Vehicle', 'link': '/policy_benefit_asset_vehicle/index',
               'role_list': ['Administrator', 'Catalog Maintenance']})
        policy_benefit_asset_property = self.create_nav_li(
            **{'icon_text': 'PBAP', 'name': 'Policy Benefit Asset Property', 'link': '/policy_benefit_asset_property/index',
               'role_list': ['Administrator', 'Catalog Maintenance']})
        policy_date = self.create_nav_li(
            **{'icon_text': 'PD', 'name': 'Policy Date', 'link': '/policy_date/index',
               'role_list': ['Administrator', 'Catalog Maintenance']})
        policy_benefit_exclusion = self.create_nav_li(
            **{'icon_text': 'PBE', 'name': 'Policy Benefit Exclusion', 'link': '/policy_benefit_exclusion/index',
               'role_list': ['Administrator', 'Catalog Maintenance']})
        policy_benefit_premium = self.create_nav_li(
            **{'icon_text': 'PBP', 'name': 'Policy Benefit Premium', 'link': '/policy_benefit_premium/index',
               'role_list': ['Administrator', 'Catalog Maintenance']})
        policy_benefit_sum_insured = self.create_nav_li(
            **{'icon_text': 'PBSI', 'name': 'Policy Benefit Sum Insured', 'link': '/policy_benefit_sum_insured/index',
               'role_list': ['Administrator', 'Catalog Maintenance']})
        policy_benefit_beneficiary = self.create_nav_li(
            **{'icon_text': 'PBB', 'name': 'Policy Benefit Beneficiary', 'link': '/policy_benefit_beneficiary/index',
               'role_list': ['Administrator', 'Catalog Maintenance']})
        application_form = self.create_nav_li(
            **{'icon_text': 'AF', 'name': 'Application Form', 'link': '/application_form/index',
               'role_list': ['Administrator', 'Catalog Maintenance']})
        policy_mgmt = self.create_nav_li(**{'icon_text': 'PN', 'name': 'Policy Management', 'link': '/policy/index', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        claim_reg = self.create_nav_li(**{'icon_text': 'CR', 'name': 'Claims Registration', 'link': '/claim/registration', 'role_list' : ['Administrator', 'ClaimsRegistration']})
        claim_mgmt = self.create_nav_li(**{'icon_text': 'CM', 'name': 'Claims Management', 'link': '/claim/management', 'role_list' : ['Administrator', 'ClaimsManagement']})
        claim_approve = self.create_nav_li(**{'icon_text': 'CA', 'name': 'Claims Approval', 'link': '/claim/approval', 'role_list' : ['Administrator', 'ClaimsApproval']})

        alloc = self.create_nav_li(**{'icon_text': 'A', 'name': 'Allocations', 'link': '/product/allocations', 'role_list' : ['Administrator', 'ProductSetup']})
        gl_accounts = self.create_nav_li(**{'icon_text': 'GL', 'name': 'GL Accounts', 'link': '/product/gl_accounts', 'role_list' : ['Administrator', 'ProductSetup']})
        suspense_accounts = self.create_nav_li(**{'icon_text': 'SA', 'name': 'Suspense Accounts', 'link': '/product/suspense_accounts', 'role_list' : ['Administrator', 'ProductSetup']})
        loaders = self.create_nav_li(**{'icon_text': 'PL', 'name': 'Product Loaders', 'link': '/setup/loaders', 'role_list' : ['Administrator', 'ProductSetup']})
        rate_tables = self.create_nav_li(**{'icon_text': 'RT', 'name': 'Rate Tables', 'link': '/setup/premium_rates', 'role_list' : ['Administrator', 'ProductSetup']})
        rounding_rates = self.create_nav_li(**{'icon_text': 'RR', 'name': 'Rounding Rates', 'link': '/setup/rounding_rates', 'role_list' : ['Administrator', 'ProductSetup']})
        claim_question = self.create_nav_li(**{'icon_text': 'CQ', 'name': 'Claim Questions', 'link': '/setup/claim_questions', 'role_list' : ['Administrator', 'ProductSetup']})
        cover_and_exclusion = self.create_nav_li(**{'icon_text': 'CE', 'name': 'Cover & Exclusions', 'link': '/setup/cover_exclusions', 'role_list' : ['Administrator', 'ProductSetup']})
        batch_import = self.create_nav_li(**{'icon_text': 'BI', 'name': 'Batch Import', 'link': '/batchimport/index', 'role_list' : ['Administrator', 'Membership']})
        dms_mgnt = self.create_nav_li(**{'icon_text': 'DMS', 'name': 'DMS Management', 'link': '/media/manage', 'role_list' : ['DMS User']})

        if not any([members_all, policy_mgmt, claim_reg, claim_mgmt, \
                claim_approve, product, alloc, gl_accounts, suspense_accounts, \
                loaders, rate_tables, rounding_rates, claim_question, \
                cover_and_exclusion, batch_import, dms_mgnt]):
            return ''

        #product_sandbox = (**{'icon_text': 'PS', 'name': 'Product Sandbox', 'link': '/product/sandbox', 'role_list' : []})
        #industry = self.create_nav_li(**{'icon_text': 'IR', 'name': 'Industry Rates', 'link': '/setup/industry', 'role_list' : ['Administrator', 'ProductSetup']})
        #investment_fund = self.create_nav_li(**{'icon_text': 'IF', 'name': 'Investment Fund', 'link': '/product/investment', 'role_list' : ['Administrator', 'ProductSetup']})

        html = f"""
          <li>
            <a data-toggle="collapse" href="#operationalCollapse">
              <i class="now-ui-icons design_image"></i>
              <p> Operational <b class="caret"></b>
              </p>
            </a>
            <div class="collapse" id="operationalCollapse">
              <ul class="nav">
                {members_all}
                {product}
                {policy_new}
                {beneficiary_new}
                {policy_benefit_status}
                {policy_benefit_loader}
                {policy_status}
                {policy_benefit_asset_vehicle}
                {policy_benefit_asset_property}
                {policy_date}
                {policy_benefit_exclusion}
                {policy_benefit_premium}
                {policy_benefit_sum_insured}
                {policy_benefit_beneficiary}
                {application_form}
                {policy_mgmt}
                {claim_reg}
                {claim_mgmt}
                {claim_approve}
                {alloc}
                {gl_accounts}
                {suspense_accounts}
                {loaders}
                {rate_tables}
                {rounding_rates}
                {claim_question}
                {cover_and_exclusion}
                {batch_import}
                {dms_mgnt}
              </ul>
            </div>
          </li>
        """
        return html

    def get_sidebar_reports_dropdown(self, *args, **kwargs):

        policy_sales = self.create_nav_li(**{'icon_text': 'PS', 'name': 'Policy Sales', 'link': '/reports/policy_sales', 'role_list' : ['Administrator', 'StatisticalReports', 'FinancialReports']})
        alloc_report = self.create_nav_li(**{'icon_text': 'AR', 'name': 'Allocation Report', 'link': '/reports/allocations', 'role_list' : ['Administrator', 'StatisticalReports', 'FinancialReports']})
        gl_account_report = self.create_nav_li(**{'icon_text': 'GL', 'name': 'GL Extract', 'link': '/reports/gl_accounts', 'role_list' : ['Administrator', 'FinancialReports']})
        recon = self.create_nav_li(**{'icon_text': 'RE', 'name': 'Receipt Recon', 'link': '/reports/recon', 'role_list' : ['Administrator', 'FinancialReports']})
        if not any([policy_sales, alloc_report, gl_account_report, recon]):
            return ''

        # liability_report = (**{'icon_text': 'LR', 'name': 'Liability Report', 'link': '/reports/liability', 'role_list' : ['Administrator', 'StatisticalReports', 'FinancialReports']})
        # members_report = (**{'icon_text': 'MR', 'name': 'Members Report', 'link': '/reports/members', 'role_list' : ['Administrator', 'StatisticalReports', 'FinancialReports']})
        # debit_orders = (**{'icon_text': 'DO', 'name': 'Debit Orders', 'link': '/reports/debit_orders', 'role_list' : ['Administrator', 'FinancialReports']})

        html = f"""
          <li>
            <a data-toggle="collapse" href="#reportCollapse">
              <i class="now-ui-icons education_atom"></i>
              <p> Reports <b class="caret"></b> </p>
            </a>
            <div class="collapse" id="reportCollapse">
              <ul class="nav">
                {policy_sales}
                {alloc_report}
                {gl_account_report}
                {recon}
              </ul>
            </div>
          </li>
        """
        return html

    def get_sidebar_setup_dropdown(self, *args, **kwargs):

        branding = self.create_nav_li(**{'icon_text': 'BR', 'name': 'Branding', 'link': '/branding', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        holiday = self.create_nav_li(**{'icon_text': 'HL', 'name': 'Holiday', 'link': '/setup/holiday', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        system_params = self.create_nav_li(**{'icon_text': 'SP', 'name': 'System Params', 'link': '/setup/system_params', 'role_list' : ['Developer']})
        audit = self.create_nav_li(**{'icon_text': 'AT', 'name': 'Audits', 'link': '/setup/audit', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        region_district_centre = self.create_nav_li(**{'icon_text': 'RE', 'name': 'Region/District/Center', 'link': '/location/index', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        banks = self.create_nav_li(**{'icon_text': 'BA', 'name': 'Banks', 'link': '/setup/banks', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        entity = self.create_nav_li(**{'icon_text': 'OG', 'name': 'Organisation', 'link': '/entity/index', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        intermediaries = self.create_nav_li(**{'icon_text': 'IN', 'name': 'Intermediaries', 'link': '/intermediary/index', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        campaigns = self.create_nav_li(**{'icon_text': 'CA', 'name': 'Campaigns', 'link': '/campaign/campaigns', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        campaign_types = self.create_nav_li(**{'icon_text': 'CT', 'name': 'Campaign Type', 'link': '/campaign/campaign_types', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        service_providers = self.create_nav_li(**{'icon_text': 'SP', 'name': 'Service Providers', 'link': '/entity/service_providers', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        service_provider_category = self.create_nav_li(**{'icon_text': 'CT', 'name': 'Categories', 'link': '/setup/service_provider_category', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        currencies = self.create_nav_li(**{'icon_text': 'CR', 'name': 'Currencies', 'link': '/setup/currencies', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        users_access = self.create_nav_li(**{'icon_text': 'UA', 'name': 'Users & Access', 'link': '/useraccess/index', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        claim_reasons = self.create_nav_li(**{'icon_text': 'CL', 'name': 'Claims Reasons', 'link': '/setup/claim_reasons', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        system_documents = self.create_nav_li(**{'icon_text': 'SD', 'name': 'System Documents', 'link': '/setup/system_documents', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        mail_merge = self.create_nav_li(**{'icon_text': 'MM', 'name': 'Mail Merge', 'link': '/setup/mail_merge', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        vehicle_category = self.create_nav_li(**{'icon_text': 'VC', 'name': 'Vehicle Category', 'link': '/setup/vehicle_category', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        dms_admin = self.create_nav_li(**{'icon_text': 'DMA', 'name': 'DMS Admin', 'link': '/media/admin', 'role_list' : ['DMS Administrator']})

        if not any([branding, holiday, system_params, audit, region_district_centre, banks, entity, intermediaries, campaigns, campaign_types, \
                service_providers, service_provider_category, currencies, users_access, claim_reasons, \
                system_documents, mail_merge, vehicle_category, dms_admin]):
            return ''

        #intermediary_disclosure = self.create_nav_li(**{'icon_text': 'IB', 'name': 'Disclosure', 'link': '/setup/intermediary_disclosure', 'role_list': ['Administrator', 'Catalog Maintenance']})
        #groups = self.create_nav_li(**{'icon_text': 'GR', 'name': 'Groups', 'link': '/groups/index', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        #affinity_stack = (**{'icon_text': 'AS', 'name': 'Affinity Stack', 'link': '/setup/affinity', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        #service_providers = (**{'icon_text': 'SP', 'name': 'Service Providers', 'link': '/setup/service_providers', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        #service_providers_types = (**{'icon_text': 'ST', 'name': 'Service Provider Types', 'link': '/setup/service_providers_types', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        #disease_codes = (**{'icon_text': 'DC', 'name': 'Disease Codes', 'link': '/setup/disease_codes', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        #system_params = (**{'icon_text': 'SP', 'name': 'System Parameters', 'link': '/setup/system_params', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        #payment_method = (**{'icon_text': 'PM', 'name': 'Payment Method', 'link': '/setup/payment_method', 'role_list' : ['Administrator', 'Catalog Maintenance']})
        #payment_providers = self.create_nav_li(**{'icon_text': 'PP', 'name': 'Payment Providers', 'link': '/setup/payment_providers', 'role_list' : ['Administrator', 'Catalog Maintenance']})

        html = f"""
          <li>
            <a data-toggle="collapse" href="#setupCollapse">
              <i class="now-ui-icons files_single-copy-04"></i>
              <p> Setup <b class="caret"></b> </p>
            </a>
            <div class="collapse" id="setupCollapse">
              <ul class="nav">
                {branding}
                {holiday}
                {system_params}
                {audit}
                {region_district_centre}
                {banks}
                {entity}
                {intermediaries}
                {campaigns}
                {campaign_types}
                {service_providers}
                {service_provider_category}
                {currencies}
                {users_access}
                {system_documents}
                {mail_merge}
                {vehicle_category}
                {dms_admin}
              </ul>
            </div>
          </li>
        """
        return html

    def create_nav_li(self, *args, **kwargs):
        link = kwargs.get('link', '/')
        name = kwargs.get('name', '')
        icon_text = kwargs.get('icon_text', '')
        role_list = [str(r).lower() for r in kwargs.get('role_list', [])]

        if role_list:
            user_roles = [str(r.name).lower() for r in request.identity.get('user', {}).roles]
            matches = [role for role in role_list if role in user_roles]
            if not matches: return ''

        return f"""
        <li>
          <a href="{link}">
            <span class="sidebar-mini-icon ellipsis">{icon_text}</span>
            <span class="sidebar-normal ellipsis">{name}</span>
          </a>
        </li>
        """
