# -*- coding: utf-8 -*-
"""Home controller module"""
import random, string
from tg import predicates, expose, require, redirect, validate, \
        flash, url, request, response, predicates

from calabashweb.model import *

from calabashweb.lib.tg_utils import *
from calabashweb.lib.base import BaseController

import calabashweb.lib.gateway_utils as GATEWAY

from dotenv import dotenv_values

env_vars = dotenv_values()

LOGIN_URL = env_vars.get('LOGIN_URL', None)
REGISTER_URL = env_vars.get('REGISTER_URL', None)

class HomeController(BaseController):

    def get_landing_html(self, *args, **kwargs):
        business_tools = self.get_business_tools()
        qr_section = self.get_qr_section()
        how = self.get_how_section()
        pricing = self.get_pricing_section()
        support = self.get_support_section()
        html = f"""
        {qr_section}
        {business_tools}
        {how}
        {pricing}
        {support}
        """
        javascript = """
        <script>
            $(document).ready(function(){
                console.log($('#headingDiv'));
                $('#headingDiv').load('/home/get_landing_title', function(){
                    $('.page-title').delay(500).fadeIn(800);
                });

            });
        </script>
        """
        return html + javascript
    
    @expose()
    def get_landing_title(self, *args, **kwargs):
        return f"""
            <div class="page-title" style="display: none;">
                <h1 class="text-white font-weight-bold">Join today and start accepting safe and convenient contactless payments.
                </h1>
                <p class="my-4 text-white font-weight-bold">Join the CΛLΛBΛSH family.</p>
                <a href="{REGISTER_URL}" class="btn btn-success btn-round text-white mt-4">Get started</a>
            </div>
        """
    
    @expose()
    def get_business_tools(self, *args, **kwargs):
        html = f"""
        <div class="section pt-7 pb-0">
            <div class="qr-section bg-gradient-success" style="background-image: url('/img/1.svg')">
                <div class="container">
                    <div class="row">
                        <div class="col-md-4 text-justify d-flex flex-column mt-5">
                            <h3 class="display-3 mb-4 text-white">Business tools</h3>
                            <p class="text-white">Keep your finger on the pulse with our user friendly business portal.  Enjoy a realtime view of all 
                                your transactions.</p>
                        </div>
                        <div class="offset-md-1 col-md-7 ml-auto mr-auto">
                            <img src="/img/myBusiness.png" class="rounded deep-shadow transform-perspective-right card-lift--hover"
                                style="max-width: 100%;">
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
        """
        return html

    @expose()
    def get_qr_section(self, *args, **kwargs):
        html = f"""
        <div class="section overlap-section">
            <div class="container">
                <div class="row">
                    <div class="col-lg-6 col-md-6 d-flex justify-content-center flex-column">
                        <h2 class="title">Start accepting all major <br> QR payments today</h2>
                        <h4 class="description">Calabash makes accepting QR payments simple by providing a single interoperable QR solution. </h4>
                        <h4 class="description">This means that you do not have to sign up to multiple providers or force your customers to download more apps. Let us do the hard work for you by providing you with a single QR code and an easy to use business portal.</h4>
                        <h3 class="mt-4">Get paid safely, simply, quickly.</h3>
                    </div>
                    <div class="offset-md-1 col-md-5">
                        <img src="/img/calabashpay_dlqr_550px.png" style="max-width: 100%;">
                        <img src="/img/qr_branding_720.png" class="my-5" style="max-width: 100%;">
                    </div>
                </div>
            </div>
        </div>
        """
        return html
    
    def get_how_section(self, *args, **kwargs):
        html = f"""
        <div class="section pt-0">
            <div class="section-background" style="background-image: url('/img/1.svg')"></div>
            <div class="container my-9">
                <div class="row justify-content-center">
                    <div class="col-lg-12">
                    <div class="row">
                        <div class="col-md-8 text-center mx-auto">
                            <h3 class="display-3">How it works</h3>
                            <p class="lead">Get up and running in a few simple steps.</p>
                        </div>
                    </div>
                        <div class="row row-grid mt-5">
                            <div class="col-lg-4">
                                <div class="info info-hover-warning text-left card-lift--hover shadow border-0">
                                    <h5 class="info-title text-uppercase px-0 text-warning mt-0">Sign up</h5>
                                    <p class="description opacity-8">
                                        Create an account by clicking on  'Get started' and tell us about yourself.
                                    </p>
                                    <div class="text-right">
                                        <a href="{REGISTER_URL}" class="btn btn-success btn-round text-white mt-4">Get started</a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="info info-hover-success text-left card-lift--hover shadow border-0">
                                    <h5 class="info-title text-uppercase px-0 text-success mt-0">Verify</h5>
                                    <p class="description opacity-8">
                                        Provide us with all the required documents and let's get to know you better.
                                    </p>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="info info-hover-danger text-left card-lift--hover shadow border-0">
                                    <h5 class="info-title text-uppercase px-0 text-danger mt-0">Get paid</h5>
                                    <p class="description opacity-8">
                                        Start receiving safe and secure contactless payments with instant settlement 
                                        to help you manage your cashflow.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        """
        return html

    def get_pricing_section(self, *args, **kwargs):
        html = f"""
        <div id="costing" class="card card-background features-3">
            <div class="full-background" style="background-image: url('/img/business_owner_1080px.jpg"></div>
            <div class="container my-9" style="z-index:2;">
                <div class="row text-center justify-content-center">
                    <div class="col-lg-8">
                        <h2 class="display-3 text-white">Low cost</h2>
                            <h3><span class="text-success"> make your money go further</span></h3>
                        <p class="lead text-white">
                            We keep it simple with zero upfront fees, zero monthly account fees and only a 3% excl transaction fee.</p>
                    </div>
                </div>
                <div class="row mt-5">
                    <div class="col-md-4">
                        <div class="card card-pricing bg-info border-0 text-center mb-4 pb-4" data-animation="zooming">
                            <div class="card-header bg-transparent">
                                <h6 class="text-uppercase ls-1 text-white py-3 mb-0">Zero upfront</h6>
                            </div>
                            <div class="card-body">
                                <div class="display-2 text-white">R 0</div>
                                <span class=" text-white">once off</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-pricing bg-warning border-0 text-center mb-4 pb-4" data-animation="zooming">
                            <div class="card-header bg-transparent">
                                <h6 class="text-uppercase ls-1 text-white py-3 mb-0">Zero Monthly</h6>
                            </div>
                            <div class="card-body">
                                <div class="display-2 text-white">R 0</div>
                                <span class=" text-white">per month</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-pricing bg-success border-0 text-center mb-4 pb-4" data-animation="zooming">
                            <div class="card-header bg-transparent">
                                <h6 class="text-uppercase ls-1 text-white py-3 mb-0">Transaction rate</h6>
                            </div>
                            <div class="card-body">
                                <div class="display-2 text-white">3%</div>
                                <span class=" text-white">excl VAT</span>
                            </div>
                        </div>
                    </div>
                </div>
        
            </div>
        </div>
        """
        return html

    def get_support_section(self, *args, **kwargs):
        html = f"""
        <div class="section pt-0 py-7">
            <div class="section-background" style="background-image: url('/img/1.svg')"></div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 mx-auto text-center my-5">
                        <h3 class="display-3">With you every step of the way</h3>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-5 pr-md-0">
                        <div class="card card-pricing text-center bg-gradient-info text-white" style="height: 500px;">
                            <div class="card-header bg-transparent">
                                <h4 class="text-uppercase ls-1 text-primary py-4 mb-0 text-white">Support</h4>
                            </div>
                            <div class="card-body px-lg-6">
                                <ul class="list-unstyled">
                                    <li>
                                        <div class="d-flex align-items-center">
                                            <div>
                                                <div class="icon icon-sm icon-shape icon-shape-primary shadow rounded-circle">
                                                    <i class="fab text-white fa-whatsapp"></i>
                                                </div>
                                            </div>
                                            <div>
                                                <span class="pl-2 text-sm">WhatsApp: 081 398 6513</span>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="d-flex align-items-center">
                                            <div>
                                                <div class="icon icon-sm icon-shape icon-shape-primary shadow rounded-circle">
                                                    <i class="fas text-white fa-at"></i>
                                                </div>
                                            </div>
                                            <div>
                                                <span class="pl-2 text-sm">support@calabashpay.com</span>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="d-flex align-items-center">
                                            <div>
                                                <div class="icon icon-sm icon-shape icon-shape-primary shadow rounded-circle">
                                                    <i class="fas text-white fa-phone-alt"></i>
                                                </div>
                                            </div>
                                            <div>
                                                <span class="pl-2 text-sm">012 111 0345</span>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="d-flex align-items-center">
                                            <div>
                                                <div class="icon icon-sm icon-shape icon-shape-primary shadow rounded-circle">
                                                    <i class="fas text-white fa-mobile-alt"></i>
                                                </div>
                                            </div>
                                            <div>
                                                <span class="pl-2 text-sm">Please call me: 081 398 6513</span>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="d-flex align-items-center">
                                            <div>
                                                <div class="icon icon-sm icon-shape icon-shape-primary shadow rounded-circle">
                                                    <i class="fas text-white fa-headset"></i>
                                                </div>
                                            </div>
                                            <div>
                                                <span class="pl-2 text-sm">Operating hours: </span>
                                            </div>
                                        </div>
                                    </li>
                                    <div class="d-flex justify-content-between mt-2"><span>Mon - Fri:</span> <span class="ml-auto pr-4">08:00 - 20:00</span></div>
                                    <div class="d-flex justify-content-between"><span>Sat:</span><span class="ml-auto pr-4">08:00 - 15:00</span></div>
                                    <div class="d-flex justify-content-between"><span>Public Holidays:</span><span class="ml-auto pr-4">08:00 - 15:00</span></div>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-7 pl-md-0">
                        <div class="card card-pricing border-0 text-center my-5 support-card" style="height: 400px;">
                            <img src="/img/support.jpg"/>
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
        """
        return html

    def get_register_html(self, *args, **kwargs):
        register_form = self.get_register_form()
        html = f"""
        <div class="container">
            <div class="header-body">
                <div class="row align-items-center">
                    <div class="col-lg-6 col-12 mx-md-auto overlay-card-container">
                        <h2 class="card-title text-white my-5 text-center">Register as a Merchant</h2>
                        <div class="card bg-secondary shadow border-0 login-card">
                            <div id="formDiv" class="card-body bg-white px-lg-5 py-lg-5">
                                <div id="loadingDiv" style="display:none;">
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <span class="ml-2">
                                            Processing...
                                        </span>
                                    </div>
                                </div>
                                <div id="successMessage" style="display:none;">
                                    <h3><strong>Success!</strong></h3>
                                    We will send you an email shortly with the next steps in the registration process. Welcome aboard!
                                    <a class="btn btn-primary btn-block mt-4 text-white"
                                        href="/">Done</a>
                                </div>
                                <div id="errorMessage" style="display:none;">
                                    <h3><strong>Oops!</strong></h3>
                                    Something went wrong, please try again.
                                    <button id="retryBtn" type="button" class="btn btn-danger btn-block mt-4 text-white">Try Again</button>
                                </div>
                                {register_form}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        """
        javascript = """
        <script>
            var registerForm = $('#registerForm');
            setFormValidation(registerForm);
            var loadingDiv = $('#loadingDiv');
            $('#registerBtn').click(function(e){
                e.preventDefault();
                var valid = FormIsValid(registerForm);
                if(valid){
                    var formserial = getFormData(registerForm);
                    $('#registerForm').slideUp('slow');
                    loadingDiv.slideDown('slow');
                    $.post('/home/register_merchant', formserial, function(data){
                        var result = JSON.parse(data);
                        if (result.success){
                            loadingDiv.slideUp('slow');
                            $('#successMessage').slideDown('slow');
                        } else {
                            loadingDiv.slideUp('slow');
                            $('#errorMessage').slideDown('slow');
                        }
                        console.log(result.success);
                        return false;
                    });
                }
            });
            var acceptCheck = $('#acceptCheck');
            var registerBtn = $('#registerBtn');
            acceptCheck.change(function(){
                if(acceptCheck.is(':checked')){
                    registerBtn.removeAttr('disabled');
                } else {
                    registerBtn.attr('disabled', 'disabled');
                }
            });
            $('#retryBtn').click(function(){
                $('#errorMessage').slideUp('slow');
                $('#registerForm').slideDown('slow');
                return false;
            });
        </script>
        """
        return html + javascript

    def get_register_form(self, *args, **kwargs):
        name_dict = {
            'input_id': 'firstName',
            'fa_icon': 'far fa-user',
            'input_attrs': 'placeholder="Name" required',
            'input_val': ''
        }
        surname_dict = {
            'input_id': 'surname',
            'fa_icon': 'far fa-envelope',
            'input_attrs': 'placeholder="Surname" required',
            'input_val': ''
        }
        mobile_dict = {
            'input_id': 'mobile',
            'fa_icon': 'fas fa-mobile-alt',
            'input_attrs': 'placeholder="Mobile number" required',
            'input_val': ''
        }
        email_dict = {
            'input_id': 'email',
            'fa_icon': 'far fa-envelope',
            'input_wrapper_class': 'mb-4',
            'input_type': 'email',
            'input_attrs': 'placeholder="Email" required',
            'input_val': ''
        }
        selectbox_merchant_type = self.get_selectbox_merchant_type(**{'id': 'merchant_ownership_type_id', 'required': True})
        ownership_type_dict = {
            'fa_icon': 'fas fa-project-diagram',
            'input_wrapper_class': 'mb-4',
            'input_type': 'custom',
            'input_field': selectbox_merchant_type
        }
        company_name_dict = {
            'input_id': 'company_name',
            'fa_icon': 'far fa-building',
            'input_wrapper_class': 'mb-4',
            'input_attrs': 'placeholder="Company Name" required',
            'input_val': ''
        }
        trading_name_dict = {
            'input_id': 'trading_name',
            'fa_icon': 'far fa-registered',
            'input_wrapper_class': 'mb-4',
            'input_attrs': 'placeholder="Trading Name" required',
            'input_val': ''
        }
        store_name_dict = {
            'input_id': 'store_name',
            'fa_icon': 'fas fa-store',
            'input_wrapper_class': 'mb-4',
            'input_attrs': 'placeholder="Store Name" required',
            'input_val': ''
        }
        selectbox_merchant_industry_type = self.get_selectbox_merchant_industry_type(**{'id': 'merchant_industry_id', 'required': True})
        industry_type_dict = {
            'fa_icon': 'fas fa-industry',
            'input_wrapper_class': 'mb-4',
            'input_type': 'custom',
            'input_field': selectbox_merchant_industry_type
        }
        industry_other_dict = {
            'input_wrapper_attrs': 'id="industryOther" style="display:none;"',
            'wrapper_class': 'row col-md-12 mb-4',
            'input_id': 'industry',
            'fa_icon': 'fas fa-industry',
            'input_wrapper_class': 'mb-4',
            'input_attrs': 'placeholder="Other Industry" required',
            'input_val': ''
        }
        accept_dict = {
            'input_type': 'widget',
            'widget': '''
            <div class="custom-control custom-checkbox mb-5 ml-9px">
                <input class="custom-control-input" name="accept" id="acceptCheck" type="checkbox">
                <label class="custom-control-label" for="acceptCheck">
                    <span>I accept the <a href="/terms">Terms and Conditions</a></span>
                </label>
            </div>
            '''
        }
        action_dict = {
            'input_type': 'widget',
            'widget': '<button id="registerBtn" class="btn btn-primary btn-block" disabled>Register</button>'
        }
        params_list = [
            name_dict,
            surname_dict,
            mobile_dict,
            email_dict,
            ownership_type_dict,
            company_name_dict,
            trading_name_dict,
            store_name_dict,
            industry_type_dict,
            industry_other_dict,
            accept_dict,
            action_dict,
        ]
        javascript = """
        <script>
            var merchantIndId = $('#merchant_industry_id');
            var industryOther = $('#industryOther');
            merchantIndId.on('change', function(){
                if($('#merchant_industry_id option:selected').val() === '13'){
                    industryOther.slideDown('slow');
                } else {
                    industryOther.slideUp('slow');
                }
            });
        </script>
        """
        return build_html_form('registerForm', params_list, True) + javascript

    def get_selectbox_merchant_industry_type(self, *args, **kwargs):
        industry_list = self.get_merchant_industry_list()
        kwargs['empty_message'] = 'Choose your Industry...'
        kwargs['case_sensitive'] = True
        kwargs['outputlist'] = industry_list
        return create_selectbox_html(**kwargs)
    
    def get_merchant_industry_list(self, *args, **kwargs):
        result = GATEWAY.get_merchant_industry_list()
        if not result.get('success'): return []
        data = result.get('data', None)
        if not data: return []
        return data

    def get_selectbox_merchant_type(self, *args, **kwargs):
        result = GATEWAY.get_merchant_ownership_types()
        type_list = result.get('data', []) if result.get('success') else []
        kwargs['empty_message'] = 'Choose your Business Type...'
        kwargs['case_sensitive'] = True
        kwargs['outputlist'] = type_list
        return create_selectbox_html(**kwargs)

    @expose()
    def register_merchant(self, *args, **kwargs):
        email = kwargs.get('email', None)
        if not email:
            return json.dumps({'success': False, 'message': '', 'status': 'danger'})
        kwargs['username'] = email
        kwargs['password'] = self.get_random_string()
        kwargs['sendMail'] = False
        result = GATEWAY.register_merchant(kwargs)
        return json.dumps(result)

    def get_random_string(self, length=16, *args, **kwargs):
        letters = string.ascii_lowercase
        return ''.join(random.choice(letters) for i in range(length))
