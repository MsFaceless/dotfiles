#!/bin/python

class SomeClass:

    def scratch():
        if not entity_id: return ''

        entity = Entity.by_id(entity_id)
        if not entity: return ''

        entity_person = EntityPerson.by_attr_first('entity_id', entity.id)
        if not entity_person: return None
        personobj = vault.get_personobj_by_id(entity_person.person_id)

        extra_form_fields =f"""
            <div class='row'>
                <div class="col-md-12">
                    <h4 class="card-title">{_("Additional Details")}</h4>
                </div>
                <div class ="col-md-6">
                    <div class="col-md-12">
                        <div class="form-group row">
                            <label class="col-md-3 col-form-label" required for="code">Code</label>
                            <div class="col-md-9">
                                <input id="code" type="text" name="code" class="form-control" required='true'>
                            </div>
                        </div>
                    </div>
                </div>
                <div class='col-md-6'>
                    <div class="col-md-12">
                        <div class="form-group row">
                            <label class="col-md-3 col-form-label" for="financial_regulatory_number">Financial Reg</label>
                            <div class="col-md-9">
                                <input id="financial_regulatory_number" type="text" name="financial_regulatory_number" class="form-control">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        """

        card_member_details = COMMON.get_edit_member_details(**{
            'person_vault': personobj,
            'form_id': 'form_edit_person',
            'entity_person_id': entity_person.id,
            'save_button_id': 'btn_save_edit_person',
            'extra_form_fields': extra_form_fields,
            })

        # card_member_contact = self.get_edit_member_contact_html(**kwargs)
        # card_member_address = self.get_edit_member_address_html(**kwargs)
        # card_member_bank = self.get_edit_member_bank_html(**kwargs)
        html = f"""
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <div class="row d-flex">
                        <div class="col-md-8">
                            <h4 class="card-title">Edit: {entity_intermediary.code} </h4>
                        </div>
                        <div class="col-md-4 text-right">
                            <button class="btn btn-primary ml-auto person_back">Back to Intermediary List</button>
                        </div>
                    </div>
                    <div class="row d-flex">
                        <div class="col-md-12">
                            <hr>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            <div class="row">
                <div class="col-md-12 ml-auto mr-auto">
                    <div class="col-md-12 ml-auto mr-auto">
                        {card_member_details}
                    </div>
                </div>
            </div>
        """

                    # {card_member_contact}
                    # {card_member_address}
                    # {card_member_bank}

        return html

# $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

# $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

        dropdown_entity_type = COMMON.get_selectbox_entity_type()
        dropdown_disclosure_id = self.get_selectbox_disclosure_id()
        entity_id = kwargs.get('entity_id', None)
        if not entity_id:
            return ''
        this = self.get_intermediary_by_id(*args, **kwargs)
        if not this:
            return ''
        checked = 'checked' if this.active else ''
        html = f"""
                    <div class="modal fade" id="dialog_edit_intermediary" tabindex="-1" role="dialog" aria-labelledby="myintermediariesLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <div class="col-md-6">
2                                        <h4 class="card-title">Edit Intermediary</h4>
                                    </div>
                                </div>
                                <div class="modal-body">
                                    <form id='form_edit_intermediary'>
                                        <div class="col-md-12">
                                            <div class="form-group row">
                                                <label class="col-md-3 col-form-label" required for="code">Code</label>
                                                <div class="col-md-9">
                                                    <input id="code" type="text" name="code" value="{this.code}" class="form-control" required='true'>
                                                </div>
                                            </div>
                                        </div>
                                        <div style='display: none' class="col-md-6">
                                                <div class="form-group row">
                                                        <label class="col-md-3 col-form-label" required for="intermediary_id">ID</label>
                                                        <div class="col-md-9">
                                                                <input id="id" type="text" name="intermediary_id" value="{this.id}" class="form-control" required='true'>
                                                        </div>
                                                </div>
                                        </div>
                                        <div class="col-md-12">
                                            <div class="form-group row">
                                                <label class="col-md-3 col-form-label" required for="entity_type_id" value="{this.entity_type_id}">{_('Entity Type')}</label>
                                                    <div class="col-md-9">
                                                        {dropdown_entity_type}
                                                    </div>
                                            </div>
                                        </div>
                                        <div class="col-md-12">
                                            <div class="form-group row">
                                                <label class="col-md-3 col-form-label" required for="entity_intermediary_disclosure_id" value="{this.entity_intermediary_disclosure_id}">{_('Disclosure Id')}</label>
                                                    <div class="col-md-9">
                                                        {dropdown_disclosure_id}
                                                    </div>
                                            </div>
                                        </div>

                                      <div class="col-md-12">
                                        <div class="form-group row">
                                            <label class="col-3 col-form-label" for="active" required>Active</label>
                                            <div class="col-9">
                                                <div class="form-check">
                                                    <label class="form-check-label">
                                                        <input class="form-check-input" type="checkbox" name="active" id="active" {checked}/>
                                                        <span class="form-check-sign"></span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button id='save_edit_intermediary' class="btn btn-primary">Save</button>
                                    <button class="btn btn-outline-primary intermediaries_back" data-dismiss="modal">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    """
        javascript = """
                <script>
                    setFormValidation('#form_edit_intermediary');
                    $('#save_edit_intermediary').click(function(){
                        var valid = FormIsValid("#form_edit_intermediary");
                        if(valid){
                            var formserial = getFormData('#form_edit_intermediary');
                            var data = {data : JSON.stringify(formserial)};

                            $.post('/intermediary/select_new_intermediary?', data, function(data){
                                var result = JSON.parse(data);
                                if(result.success === true){
                                    $.redirect('/intermediary/index');
                                    };
                                return false;
                                });
                            }
                        });
                    $('.intermediaries_back').click(function(){
                        $('#dialog_edit_intermediary').modal('hide');
                        });
                    $('#dialog_edit_intermediary').modal();
                </script>
                """
        return html + javascript

    @expose()
    def select_new_intermediary(self, *args, **kwargs):
        data = json.loads(kwargs.get('data', json.dumps({})))
        if not data: return json.dumps({'success': False, 'data': 'No data provided', 'status': 'danger'})

        entity_type_id = int(data.get('entity_type_id', None))
        if not entity_type_id: return json.dumps({'success': False, 'data': 'No data provided', 'status': 'danger'})

        organisation_type_id = TYPEUTIL.get_id_of_name('entity_type', 'organisation')
        if entity_type_id == organisation_type_id:
            redirect_url = '/intermediary/get_new_organisation_intermediary_html'
        else:
            redirect_url = '/intermediary/get_new_person_intermediary_html'
        return json.dumps({'success': True, 'entity_type_id': entity_type_id, 'redirect': redirect_url})
