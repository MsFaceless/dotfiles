# -*- coding: utf-8 -*-

from datetime import datetime

from tg import expose, request

from eiffel_front.model import *

from eiffel_front.lib.base import BaseController

class MasterHtmlController(BaseController):

    @expose()
    def get_navbar_html(self, *args, **kwargs):
        splash_item = Splash.latest_entry()
        logo_filename = splash_item.logo_filename if splash_item else 'calabash_campus_logo.svg'

        if request.identity:
            usernow = request.identity.get('user', {})
            account_html = """
            <li id="myAccountLink" class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown"
                    aria-haspopup="true" aria-expanded="false">
                    My Account
                </a>
                <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                    <a class="dropdown-item" href="/my_account">Edit Profile</a>
                    <a class="dropdown-item" href="/my_account/my_ads">My Ads</a>
                    <a class="dropdown-item" href="/my_account/pending_purchases">My Purchases</a>
                    <a class="dropdown-item" href="/my_account/direct_message">Direct Message</a>
                    <a class="dropdown-item" href="/my_account/sales">My Sales</a>
                </div>
            </li>
            """
            notification_html = """
            <li class="nav-item">
                <span id="counter_span" class="hidden" data-notifications='0' data-chats='0'></span>
                <a id="notifMain" class="nav-link notification_link" href="/my_account/direct_message">
                    Notifications
                    <span id="notifMainBadge" class='ml-1 badge badge-pill badge-danger'></span>
                </a>
            </li>
            """
            login_html = """
            <a class="btn btn-outline-primary my-2 my-sm-0 btn_logout" href="/logout_handler">Logout</a>
            <div id="create_ad" class="btn btn-primary my-2 my-sm-0 ml-2"><i class="fa fa-plus-circle"></i>
                Create Ad
            </div>
            """

        else:
            account_html = """
            <li class="nav-item">
                <div id="myAccountBtn" class="nav-link">My Account</div>
            </li>
            """
            notification_html = """
            <li class="nav-item">
                <div id="notifMainBtn" class="nav-link notification_link">
                    Notifications
                </div>
            </li>
            """
            login_html = """
            <div id="login_button" class="btn btn-primary my-2 my-sm-0">Login</div>
            <div id="register_button" class="btn btn-outline-primary ml-2 my-sm-0">Register</div>
            """


        html = f"""
        <div class="container">
            <div id="mobile_search" class="mr-4">
                <i class="fa fa-search" aria-hidden="true"></i>
            </div>
            <a class="navbar-brand" href="/">
                <img src="/img/{logo_filename}" class="image" alt="Brand Logo"></img>
            </a>
            <button class="navbar-toggler" type="button" data-toggle="slide-collapse" data-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"> </span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul id="mainNav" class="navbar-nav mr-auto ml-auto">
                    <li id="homeLink" class="nav-item active">
                        <a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a>
                    </li>
                    <li id="categoryLink" class="nav-item">
                        <a class="nav-link" href="/categories/">Categories</a>
                    </li>
                    {account_html}
                    {notification_html}
                </ul>
                <div class="form-inline my-2 my-lg-0">
                    {login_html}
                </div>
            </div>
        </div>
        """
        javascript = """
        <script>
            openModalDialog('#login_button');
            openModalDialog('#notifMainBtn');
            openModalDialog('#myAccountBtn');

            $.post("/set_session_data", function(data){
                return false;
            });
            $('#register_button').click(function(){
                $.redirect('/my_account/register');
            });
            $('#create_ad').click(function(){
                $.redirect('/my_account/create_ad');
            });
            if($('.search_container').length == 0){
                $('#mobile_search').hide();
            };
            $('#mobile_search').click(function(){
                $('.search_container').addClass('active');
                $('#backdrop').addClass('active');
            });
            $('#backdrop').click(function(){
                $('.search_container').removeClass('active');
                $('#backdrop').removeClass('active');
            });
            $(document).on('click', '[data-toggle="slide-collapse"]', function() {
                $navMenuCont = $($(this).data('target'));
                $navMenuCont.animate({
                'width': 'toggle'
                }, 350);
                $(".menu-overlay").fadeIn(500);
                setTimeout(function(){
                    $('#navbarDropdown').trigger('click');
                }, 400);
            });
            $(".menu-overlay").click(function(event) {
                $(".navbar-toggler").trigger("click");
                $(".menu-overlay").fadeOut(500);
            });
        </script>
        """
        return html + javascript

    @expose()
    def get_footer_html(self, *args, **kwargs):
        if request.identity:
            usernow = request.identity.get('user', {})
            account_html = """
            <li><a href="/my_account/create_ad">Create Ad</a></li>
            <li><a href="/my_account/pending_purchases">My Orders</a></li>
            <li><a href="/my_account/direct_message">Direct Message</a></li>
            """

        else:
            account_html = """
            <li><div class="text_link" id='create_ad_btn'>Create Ad</div></li>
            <li><div class="text_link" id='my_orders_btn'>My Orders</div></li>
            <li><div class="text_link" id='direct_message_btn'>Direct Message</div></li>
            <script>
                openModalDialog('#create_ad_btn', '/my_account/create_ad');
                openModalDialog('#my_orders_btn', '/my_account/pending_purchases');
                openModalDialog('#direct_message_btn', '/my_account/direct_message');
            </script>
            """

        splash_item = Splash.latest_entry()
        splash_about = ''
        if splash_item and splash_item.about:
            splash_about = splash_item.about

        google_store_link = 'https://play.google.com/store'
        google_url = DBSession.query(MobileAppLinks). \
                filter(MobileAppLinks.title == 'Google Play Store'). \
                filter(MobileAppLinks.active == True). \
                first()
        if google_url:
            google_store_link = google_url.url

        apple_store_link = 'https://www.apple.com/ios/app-store/'
        apple_url = DBSession.query(MobileAppLinks). \
                filter(MobileAppLinks.title == 'Apple Store'). \
                filter(MobileAppLinks.active == True). \
                first()
        if apple_url:
            apple_store_link = apple_url.url

        html = f"""
        <div class="wave-shape shape-top" data-negative="false">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" preserveAspectRatio="none">
                <path class="wave-shape-fill" d="M421.9,6.5c22.6-2.5,51.5,0.4,75.5,5.3c23.6,4.9,70.9,23.5,100.5,35.7c75.8,32.2,133.7,44.5,192.6,49.7
                c23.6,2.1,48.7,3.5,103.4-2.5c54.7-6,106.2-25.6,106.2-25.6V0H0v30.3c0,0,72,32.6,158.4,30.5c39.2-0.7,92.8-6.7,134-22.4
                c21.2-8.1,52.2-18.2,79.7-24.2C399.3,7.9,411.6,7.5,421.9,6.5z"></path>
            </svg>
        </div>
        <div class="container">
            <div class="row">
                <div class="col-lg-4 col-md-7 offset-md-1 offset-lg-0">
                    <div class="block about">
                        <h4>Eiffel Corp</h4>
                        <p class="text-white">
                            {splash_about}
                        </p>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 offset-md-1 offset-lg-1">
                    <div class="block">
                        <h4>My Account</h4>
                        <ul>
                            {account_html}
                        </ul>
                    </div>
                </div>
                <div class="col-lg-4 col-md-4 offset-md-1 offset-lg-1">
                    <div class="block">
                        <p class="text-white">You need a CΛLΛBΛSH account to transact on this site. Ts and Cs apply:</p>
                        <a href='{google_store_link}' target='_blank'>
                            <img src="/img/google_play_badge.png" style="height: 50px;" alt="Google Play store badge"/><br/>
                        </a>
                        <a href='{apple_store_link}' target='_blank'>
                            <img src="/img/App_Store_badge.svg" style="height: 50px;" class="mt-3" alt="Apple Store badge"/>
                        </a>
                        <p class="text-white mt-3">Download the CΛLΛBΛSH app here.</p>
                    </div>
                </div>
            </div>
        </div>
        """
        return html

    @expose()
    def get_footer_bottom_html(self, *args, **kwargs):

        dbase_query = SocialLinks.get_limit(limit=5)
        social_links = ""
        for link in dbase_query:
            social_links += f"""<li><a class="mdi mdi-14px {link.icon}" href="http://{link.url}" target="_blank"></a></li>"""

        current_year = datetime.now().strftime('%Y')
        html = f"""
        <div class="container">
            <div class="row">
                <div class="col-sm-6 col-12">
                    <div class="copyright">
                        <p>Eiffel Corp &copy; {current_year}. All Rights Reserved</p>
                    </div>
                </div>
                <div class="col-sm-6 col-12">
                    <ul class="social-media-icons text-right">
                        {social_links}
                    </ul>
                </div>
            </div>
        </div>
        <div class="top-to"><a class="" href="#top" id="top"><i class="fa fa-angle-up"></i></a></div>
        """
        javascript = """
        <script>
            $('#top').click(function(){
                $('html, body').animate({scrollTop:0}, 'slow');
            });
        </script>
        """
        return html + javascript
