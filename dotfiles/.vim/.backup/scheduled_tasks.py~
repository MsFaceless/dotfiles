#!/bin/python
# -*- coding: utf-8 -*-
from tg.predicates import has_permission
from tg.i18n import ugettext as _, lazy_ugettext as l_

from datetime import date, datetime
from tanzanite import model
from tanzanite.model import *
from tanzanite.lib.tg_utils import *
from tanzanite.lib.email_creator import *

from tanzanite.controllers.operational import OperationalController
from tanzanite.controllers.common import CommonController
from tanzanite.controllers.logging import LoggingController

LOGGING = LoggingController()

OPERATIONAL = OperationalController()
COMMON = CommonController()

class ScheduledTasks():
    def auto_update_soh(self, *args, **kwargs):

        usernow = DBSession.query(User).filter(User.name=='Nobody').first()

        #We assume that this is a pack and not a sleeve or outer box.
        print('started scheduled update SOH')

        print('Calling scheduled Update All')
        OPERATIONAL.rebuild_all_soh(None, usernow)
        print('Retruned from scheduled Update All')

        print('completed scheduled update SOH')
        return True


    def small_test(self, *args, **kwargs):
        print('running small test')

        usernow = DBSession.query(User).filter(User.name=='Nobody').first()
        print(usernow)

        audit = COMMON.get_type_id(AuditAction, 'Audit')
        print(audit)

        soh = COMMON.get_type_id(AuditType, 'RecalculateSOH')
        print(soh)

        result = LOGGING.add_audit_log(**{
            'audit_action_id': audit,
            'audit_type_id': soh,
            'message': 'Started Update All SOH.',
            'usernow': usernow,
        })
        print(result)
        return True

    def finalize(self, *args, **kwargs):
        print('committing')
        return True
