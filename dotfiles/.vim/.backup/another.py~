# -*- coding: utf-8 -*-
"""Main Controller"""

import datetime
import urllib.parse

from tg import expose, flash, require, url, lurl, session
from tg import request, redirect, tmpl_context
from tg.i18n import ugettext as _, lazy_ugettext as l_
from tg.exceptions import HTTPFound
from tg import predicates

from eiffel_front import model
from eiffel_front.controllers.secure import SecureController
from eiffel_front.controllers.categories import CategoryController
from eiffel_front.controllers.my_account import AccountController
from eiffel_front.controllers.posts import PostsController
from eiffel_front.controllers.useraccess import UserController

from eiffel_front.model import *

from tgext.admin.tgadminconfig import BootstrapTGAdminConfig as TGAdminConfig
from tgext.admin.controller import AdminController

import eiffel_front.lib.gateway_utils as GATEWAY

from eiffel_front.controllers.common import CommonController
from eiffel_front.lib.base import BaseController
from eiffel_front.controllers.error import ErrorController
from eiffel_front.controllers.chat import ChatController
from eiffel_front.controllers.test import TestController

__all__ = ['RootController']

class RootController(BaseController):

    secc = SecureController()
    admin = AdminController(model, DBSession, config_type=TGAdminConfig)

    chat = ChatController()
    test = TestController()
    error = ErrorController()
    posts = PostsController()
    common = CommonController()
    useraccess = UserController()
    my_account = AccountController()
    categories = CategoryController()

    def _before(self, *args, **kw):
        tmpl_context.project_name = "eiffel_front"

    @expose('eiffel_front.templates.generic')
    def index(self, *args, **kwargs):
        print()
        print('index')
        print(kwargs)
        print()
        show_login = kwargs.get('show_login', None)
        login_trigger_js = ""
        if show_login:
            came_from = kwargs.get('came_from', '/')
            login_trigger_js = f"""
            $("#dialogdiv").load("/get_login_modal?", 'came_from={came_from}', function(){{
                return false;
            }});
            """

        html = f"""
        """
        javascript = """
        """
        javascript += login_trigger_js
        return dict(title='Eiffel Corp', html=html, javascript=javascript)

    @expose()
    def login(self, came_from=lurl('/'), failure=None, login=''):
        print()
        print('login')
        print('came_from', came_from)
        print('failure', failure)
        print('login', login)
        print()
        if failure:
            return 'Username or password incorrect'
        redirect('/index', params=dict(show_login=True, came_from=came_from))

    @expose()
    def post_login(self, came_from=lurl('/')):
        print()
        print('post_login')
        print(came_from)
        print()
        data = session.get('student_dict', None)
        if not data:
            print('NO SESSION DATA')
            #usernow = request.identity.get('user', {})
            #result = GATEWAY.get_user_profile({'entity_id' : usernow.entity_id, 'passthrough': True})
            #success = result.get('success', False)
            #if not success:
            #    redirect('/index', params=dict(show_login=True, came_from=came_from))

            #data = result.get('data', {})
            #if not data:
            #    redirect('/index', params=dict(show_login=True, came_from=came_from))

            #session['student_dict'] = data
            #session.save()
        #return 'true'
        if not request.identity:
            login_counter = request.environ.get('repoze.who.logins', 0) + 1
            redirect('/login',
                     params=dict(came_from=came_from, __logins=login_counter))
        return HTTPFound(location=came_from)

    @expose()
    def post_logout(self, came_from=lurl('/')):
        print()
        print('post_logout')
        print(came_from)
        print()
        session.delete()
        return HTTPFound(location=came_from)

    @expose()
    def get_categories_list_html(self):
        dbase_query = Category.get_limit(sort_on='count', sort_direction='desc', limit=5)
        if not dbase_query:
            return ""
        categories_list = ""
        for category in dbase_query:
            categories_list += f"""<li><a href="/posts/search?id={category.id}">{category.title}</a></li>"""
        return categories_list



    @expose()
    def get_login_modal(self, *args, **kwargs):
        came_from = kwargs.get('came_from', '/')
        html = """
        <div id="login_modal" class="modal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Login</h5>
                    </div>
                    <div class="modal-body">
                        <form action="/login_handler" method="post" accept-charset="UTF-8" class="form-horizontal">
                            <div class="form-group">
                                <label class="col-sm-2 control-label">Username:</label>
                                <div class="col-sm-12">
                                    <input class="form-control" autocomplete="username" type="text" name="login" />
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="d-flex justify-content-between">
                                    <label class="col-sm-2 control-label">Password:</label>
                                    <span id="forgotPassword" class="display_link mr-15">Forgot password?</span>
                                </div>
                                <div class="col-sm-12 d-flex align-items-center">
                                    <input id="password" class="form-control" autocomplete="current-password" type="password" name="password" />
                                    <i class="mdi mdi-18px mdi-eye position-absolute view_password"></i>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-12 col-sm-offset-2">
                                    <div class="checkbox">
                                        <label style="display:none">
                                            <input type="checkbox" name="remember" value="2252000" style="display:none"/> remember me
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-12 col-sm-offset-2">
                                    <div id='submit_login' class="btn btn-primary">Login</div>
                                    <div id="cancel_btn" class="btn btn-outline-primary">Cancel</div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        """
        javascript = """
        <script>
            $('#login_modal').modal();
        </script>
        """
        return html + javascript

    @expose()
    def reset(self, *args, **kwargs):
        try: guid = args[0]
        except: redirect('/login')
        exists = StudentGuid.by_attr_first('guid', guid)
        if not exists: redirect('/login')
        redirect('/useraccess/reset', params={'guid' : guid})

    @expose('eiffel_front.templates.generic')
    def privacy(self, *args, **kwargs):
        html = """
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header card-header-primary card-header-icon">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card-icon">
                                    <i class="material-icons">visibility_off</i>
                                </div>
                                <h4 class="card-title">Privacy Statement</h4>
                            </div>
                        </div>
                    </div>
                    <div class="card-body pt-0">
                        <div class="material-datatables mt-3">
                            <h6>
                                <b>
                                    Dotxml’s commitment to information privacy
                                </b>
                            </h6>

                            <br/>

                            <h6>
                                <b>
                                    At Dotxml, we treat your personal information responsibly
                                </b>
                            </h6>

                            <ol>
                                <li>
                                    Dotxml Technologies Proprietary Limited, and all entities and subsidiaries, Registration
                                    Number 2015/243327/07 (Dotxml, it, we, us or our) has its head office at Shop F2, The
                                    Sanctuary, De Beers Avenue, Somerset West, Cape Town, South Africa.
                                </li>
                                <li>
                                    Dotxml promises to treat all your personal information carefully and responsibly.
                                </li>
                                <li>
                                    Personal information includes any information that lets Dotxml identify you as a unique
                                    individual, such as your name/s and surname combined with your physical address,
                                    contact details and/or passport/identity number.

                                </li>
                                <li>

                                    Personal information (in South Africa) also refers to the personal information that
                                    uniquely identifies a legal entity, such as the trading name of a company combined with
                                    the company registration number.
                                </li>
                                <li>

                                    Special personal information includes that which details your race or ethnic origin,
                                    religious and philosophical beliefs, political persuasion, trade union membership, health
                                    or sex life, biometric information or any criminal behaviour which relates to alleged
                                    criminal offences or proceedings.
                                </li>
                                <li>

                                    Personal information may be given to or collected by Dotxml in writing as part of a
                                    written application form, electronically (email), telephonically, online or via mobile
                                    applications.
                                </li>
                                <li>
                                    Processing of personal information includes any initial processing that Dotxml does
                                    when we first collect your personal information. It also includes any further and ongoing
                                    processing that Dotxml is allowed to carry out legitimately in terms of the reasons listed
                                    in paragraph 9 (below). The term ‘processing’ includes collecting, using, altering,
                                    merging, linking, organising, disseminating, storing, retrieving, disclosing, erasing,
                                    archiving, destroying or disposing of personal information.

                                </li>
                            </ol>

                            <h6>
                                <b>
                                    Your personal information is an important part of Dotxml’s relationship with you.
                                </b>
                            </h6>

                            <ol start='8'>
                                <li>
                                    Dotxml will only collect and process your personal information for the reason you
                                    provided it to us, or to enable us to comply with the requirements of specific laws that
                                    we are governed by.

                                </li>
                                <li>
                                    Dotxml may process your personal information to protect your or our legitimate
                                    interests. Dotxml will not collect and process personal information about you that we do
                                    not need for this purpose. The general purposes for which Dotxml collects and
                                    processes your personal information include, but are not limited to:
                                    <ol>
                                        <li>
                                            Creating a record of you on our system to verify your identity, provide you with the
                                            products and/or services you have applied for and then communicate with and keep
                                            you informed about these products and/or services;
                                        </li>
                                        <li>
                                            Identifying you and verifying your physical address, source of income and similar
                                            information;
                                        </li>
                                        <li>
                                            Any purpose related to the prevention of crime and/or terrorist activities;
                                        </li>
                                        <li>
                                            Further processing for historical, statistical or research purposes where the
                                            outcomes will not be published in an identifiable format;

                                        </li>
                                        <li>
                                            Providing income tax-related information to tax authorities;
                                        </li>
                                        <li>
                                            For purposes relating to the sale or transfer of any of our businesses, legal entities
                                            or assets as part of corporate transactions;

                                        </li>
                                        <li>
                                            Where you have applied for employment at Dotxml, we perform applicant screening
                                            and background checks;
                                        </li>
                                        <li>
                                            Where you are an Dotxml employee (including contractors), we create an
                                            employment record of you on our system to facilitate continuous monitoring during
                                            your employment with us;
                                        </li>
                                        <li>
                                            Where you are an Dotxml director, we create a record of you as a director on our
                                            system;
                                        </li>
                                        <li>
                                            Where you’ve been identified as a next of kin by an employee or customer, we
                                            create a record of you on our system; and
                                        </li>
                                        <li>
                                            Where you are a supplier to Dotxml, we process your personal information for due
                                            diligence, risk assessment, administrative and payment purposes.
                                        </li>
                                    </ol>
                                </li>
                                <li>
                                    Furthermore, Dotxml will not process your special personal information unless:
                                    <ol>
                                        <li>
                                            You have consented to Dotxml processing it;
                                        </li>
                                        <li>
                                            It is necessary to exercise or defend a right or obligation in law;
                                        </li>
                                        <li>
                                            It is necessary to comply with local and/or international legal obligations of public interest;
                                        </li>
                                        <li>
                                            It is for certain historical, research or statistical purposes that would not adversely
                                            affect your privacy; or
                                        </li>
                                        <li>
                                            You have deliberately made your information public.
                                        </li>
                                    </ol>
                                </li>
                                <li>
                                    There are some personal information fields that you have to fill in if you want Dotxml to
                                    provide you with your chosen product and/or service or on-board you as an employee,
                                    supplier, director or job applicant. This information can be provided in writing,
                                    electronically or telephonically, but it must be accurate and complete. These fields are
                                    indicated by an asterisk (or as otherwise indicated) on the respective forms/websites. If
                                    Dotxml does not receive the necessary personal information, we will not be able to
                                    continue with your application. If you are already a(n)
                                    customer/employee/supplier/director and Dotxml asks you for this information and you
                                    do not provide it, Dotxml will have to suspend the provision of the product and/or services for a period of time,
                                    or as the case may be, even terminate our relationship with you.
                                </li>
                                <li>
                                    In most cases, personal information will be collected directly from you, but there may be
                                    other instances when Dotxml will collect personal information from other sources. These
                                    may include public records, places where you may already have made your personal
                                    information public (for example, on social media), credit bureaus, or individuals/directors
                                    whom you have appointed as your representative, where you are a corporate entity.
                                    Dotxml will only collect your personal information from other sources where we are
                                    legally entitled or obliged to do so, and you are entitled to ask Dotxml which sources
                                    they used to collect your personal information.
                                </li>
                                <li>
                                    For the purposes outlined in paragraph 9 (above), Dotxml will, in most instances, collect
                                    and process your personal information internally. However, there are times when
                                    Dotxml needs to outsource these functions to third parties, either within Dotxml or
                                    external to Dotxml, including parties in other countries. Where your personal information
                                    is shared internally within Dotxml, such sharing will be carried out only for the purposes
                                    outlined in paragraph 9 (above). Dotxml may also need to share your personal
                                    information with external organisations, such as credit bureaus, tax authorities or other
                                    regulatory or industry bodies, so that we can meet our due diligence or regulatory
                                    requirements. We may need to share your personal information with our business
                                    partners or counter-parties, where we are involved in corporate transactions relating to
                                    the sale or transfer of any of our businesses, legal entities or assets. Dotxml will not
                                    share your personal information with third parties who do not need your personal
                                    information, or where Dotxml is not legally permitted to do so. When Dotxml decides to
                                    transfer your personal information to third parties, we will only provide it to organisations
                                    that have the same data privacy policies as Dotxml or those who are subject to laws
                                    relating to the processing of personal information that are similar to those that apply to
                                    Dotxml.
                                </li>
                                <li>
                                    There may be instances where Dotxml will process your personal information through a
                                    secure automated tool, or perform profiling resulting in a decision that may affect you
                                    significantly. If you are unhappy about the outcome of such a decision, please contact:
                                    <ol>
                                        <li>
                                            your Local Customer Service centre (for customers);
                                        </li>
                                        <li>
                                            your resourcing consultant (for job applicants and employees);
                                        </li>
                                        <li>
                                            your supplier relationship manager (for suppliers); or
                                        </li>
                                        <li>
                                            Dotxml’s head office (for directors of Dotxml-owned companies).
                                        </li>
                                    </ol>
                                </li>
                            </ol>

                            <h6>
                                <b>
                                    Dotxml respects your rights
                                </b>
                            </h6>

                            <ol start='15'>
                                <li>
                                    As a customer, if you have opted out of receiving electronic communications (on media
                                    such as SMS, email or automated calling machines), Dotxml will not contact you using
                                    electronic media. However, if you are receiving marketing via electronic media, youhave the right to opt out at any time by following the instructions on the marketing
                                    material received. Dotxml will continue to market to you using electronic means until
                                    such time you have opted out.
                                </li>
                                <li>
                                    As a non-customer, if you would like to receive information from Dotxml through
                                    electronic media, please submit your details to Dotxml via our website.
                                </li>
                                <li>
                                    If you have a complaint relating to the protection of your personal information, including
                                    the way in which it has been collected or processed by Dotxml, please contact us using
                                    the contact details as listed below. If you have not had your complaint dealt with
                                    satisfactorily, you may lodge a complaint with your local privacy regulator in terms of
                                    applicable privacy laws.
                                </li>
                            </ol>

                            <h6>
                                <b>
                                    Right to amend this privacy statement
                                </b>
                            </h6>

                            <p>
                            Dotxml reserves the right to change this statement at any time. All changes to this
                            statement will be posted online. Unless otherwise stated, the current version
                            shall supersede and replace all previous versions of this statement.
                            </p>

                            <h6>
                                <b>
                                    Contact details
                                </b>
                            </h6>

                            <p>
                            <b>
                                Email
                            </b>
                            support@dotxmltech.com
                            <p>

                            <p>
                            <b>
                                Website
                            </b>
                            www.dotxmltech.com
                            <p>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        """
        javascript = """
        """
        return dict(title='Privacy', html=html, javascript=javascript)


#!/bin/python

